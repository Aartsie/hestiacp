#!/bin/bash
# info: Import DirectAdmin backup to a new user
# options: BACKUP [MX]
#
# example: v-import-directadmin /backup/backup.tar.gz yes
#
# Based on sk-da-importer
# Credits: Maks Usmanov (skamasle) and contributors:
# Thanks to <https://github.com/Skamasle/sk_da_importer/graphs/contributors>

# This script is provided whitout any warranty
# Run at your own risk
# Version 0.2
# This script restore backups from DA to Hestiacp
# This script can restore Datases, databases user and passwords, mails and domains.

# shellcheck source=/usr/local/hestia/func/main.sh
source $HESTIA/func/main.sh
# shellcheck source=/etc/hestiacp/hestia.conf
source /etc/hestiacp/hestia.conf
# load config file
source_conf "$HESTIA/conf/hestia.conf"

# Turn this to 1 if you want get domains and paths from apache_owened_list
# Turn int to 2 if you want to get domains dir "domains" and set public_html as default
sk_get_dom=1
if [ ! -e /usr/bin/rsync ] || [ ! -e /usr/bin/file ]; then
	echo "#######################################"
	echo "rsync not installed, try install it"
	echo "This script need: rsync, file"
	echo "#######################################"
	if [ -e /etc/redhat-release ]; then
		echo "Run: yum install rync file"
	else
		echo "Run: apt-get install rsync file"
	fi
	exit 3
fi
# Put this to 0 if you want use bash -x to debug it
debug=1
hestia_package=default
tmp_dir=tmp_dir
b=backup
d=domains

if [ -f "$1" ]; then
	directadmin_backup="$1"
fi
if [ -n "$2" ]; then
	mx="$2"
fi
if [ -z "$BACKUP_TEMP" ]; then
	BACKUP_TEMP=$BACKUP
else
	echo "File does not exists"
	exit 1
fi

# Creating temporary directory
tmpdir=$(mktemp -p "$BACKUP_TEMP" -d)

backup_file=$1

delete_tmp() {
	echo "Removing tmp files"
	rm -rf /root/${tmp_dir}
}

tput setaf 2
echo "Checking provided file..."
tput sgr0
if file $backup_file | grep -q -c "gzip compressed data,"; then
	tput setaf 2
	echo "OK - Gziped File"
	tput sgr0
	if [ ! -d /root/${tmp_dir} ]; then
		echo "Creating tmp.."
		mkdir /root/${tmp_dir}
	fi
	echo "Extracting backup..."
	if [ "$debug" != 0 ]; then
		tar xzvf $backup_file -C /root/${tmp_dir} 2>&1 |
			while read extracted_file; do
				ex=$((ex + 1))
				echo -en "wait... $ex files extracted\r"
			done
	else
		tar xzf $backup_file -C /root/${tmp_dir}
	fi
	if [ $? -eq 0 ]; then
		tput setaf 2
		echo "Backup extracted whitout errors..."
		tput sgr0
	else
		echo "Error on backup extraction, check your file, try extract it manually"
		delete_tmp
		exit 1
	fi
else
	echo "Error 3 not-gzip - no standard gziped backup provided of file not installed ( Try yum install file, or apt-get install file )"
	delete_tmp
	exit 3
fi
cd /root/${tmp_dir}/
main_dir=$(pwd)
echo "Access tmp directory $main_dir"
directadmin_user=$(grep username backup/user.conf | cut -d "=" -f 2)
directadmin_usermail=$(grep email backup/user.conf | cut -d "=" -f 2 | grep @)
echo "Get User: $directadmin_user"
if [ -z $directadmin_usermail ]; then
	directadmin_usermail=$(grep domain backup/user.conf | cut -d "=" -f 2 | head -n 1)
fi

check_sysuser=$(cut -f 1 -d : /etc/passwd | grep "^$directadmin_user$")
if [ -n "$check_sysuser" ] || [ -e "$HESTIA/data/users/$directadmin_user" ]; then
	delete_tmp
	check_result "$E_EXISTS" "user $directadmin_user exists"
fi

echo "Generate random password for $directadmin_user and create Hestiacp Account ..."
new_password=$(generate_password)
# @TODO Checked till here
$BIN/v-add-user $directadmin_user $new_password $directadmin_usermail $hestia_package
if [ "$?" -ne 0 ]; then
	echo "Unable to create user"
	exit 1
fi

exit 0
for sk_ex1 in crontab ticket user; do
	mv backup/${sk_ex1}.conf backup/${sk_ex1}
done
# start whit databases
tput setaf 2
echo "Start Whit Databases"
tput sgr0
echo "Get local databases"
mysql -e "SHOW DATABASES" >server_dbs
sk_da_db_user_list=$(ls -1 backup/ | grep ".conf")
function sk_run_da_db() {
	for sk_da_db_u in $sk_da_db_user_list; do
		# Substring expresion -5: substring expression < 0
		# userdb=$(echo $sk_da_db_u |sed "s/.conf//")
		userdb=${sk_da_db_u::-5}
		md5=$(grep $userdb ${b}/${sk_da_db_u} | head -n 1 | tr '&' '\n ' | grep passwd | cut -d "=" -f 2)
		db=$(grep db_collation ${b}/${sk_da_db_u} | tr '&' '\n ' | grep SCHEMA_NAME | cut -d "=" -f 2)
		grep -w $db server_dbs
		if [ $? == "1" ]; then
			tput setaf 2
			echo " Create and restore ${db} "
			tput sgr0
			mysql -e "CREATE DATABASE $db"
			mysql ${db} <backup/${db}.sql
			echo "Add $db to vestacp"
			echo "DB='$db' DBUSER='$userdb' MD5='$md5' HOST='localhost' TYPE='mysql' CHARSET='UTF8' U_DISK='0' SUSPENDED='no' TIME='$TIME' DATE='$DATE'" >>/usr/local/vesta/data/users/${directadmin_user}/db.conf
		else
			echo "Error: Cant restore database $db alredy exists in mysql server"
		fi
	done
	echo "Fix passwords and users"
	$BIN/v-rebuild-databases $directadmin_user
}

if [[ -z $sk_da_db_user_list ]]; then
	echo "No database found"
else
	sk_run_da_db
fi

# Start whit domains
tput setaf 2
echo "Start Whit Domains"
tput sgr0
if [ "$sk_get_dom" = 1 ]; then
	sk_da_domain_list=$(grep "=G" ${b}/apache_owned_files.list | grep -v public_html | grep -v private_html)
else
	sk_da_domain_list=$(ls -1 domains/)
fi
for sk_da_dom in $sk_da_domain_list; do
	if [ "$sk_get_dom" = 1 ]; then
		sk_da_dom=${sk_da_dom::-2}
	fi
	tput setaf 2
	echo "Add $sk_da_dom if not exists"
	tput sgr0
	$BIN/v-add-domain ${directadmin_user} $sk_da_dom
	if [ "$?" = "4" ]; then
		tput setaf 4
		echo "Domain $sk_da_dom alredy added in some account, skip..."
		tput sgr0
	elif [ -d /home/${directadmin_user}/web/${sk_da_dom} ]; then
		echo "Domain $sk_da_dom added, restoring files"
		echo $sk_da_dom >>sk_restored_domains
		#some paths maybe change, I dont know yet so we get it.
		if [ "$sk_get_dom" = 1 ]; then
			sk_da_do_path=$(grep -w $sk_da_dom ${b}/apache_owned_files.list | grep -v "${sk_da_dom}=G" | grep -v "private_html")
			sk_da_do_path=${sk_da_do_path::-2}
		else
			sk_da_do_path=${sk_da_dom}/public_html
		fi
		if [ "$debug" != 0 ]; then
			rm -f /home/${directadmin_user}/web/${sk_da_dom}/public_html/index.html
			rsync -av ${d}/${sk_da_do_path}/ /home/${directadmin_user}/web/${sk_da_dom}/public_html 2>&1 |
				while read backup_file_dm; do
					sk_sync=$((sk_sync + 1))
					echo -en "-- $sk_sync restored files\r"
				done
			echo " "
		else
			rm -f /home/${directadmin_user}/web/${sk_da_dom}/public_html/index.html
			rsync ${d}/${sk_da_do_path}/ /home/${directadmin_user}/web/${sk_da_dom}/public_html
		fi
		chown ${directadmin_user}:${directadmin_user} -R /home/${directadmin_user}/web/${sk_da_dom}/public_html
		chmod 751 /home/${directadmin_user}/web/${sk_da_dom}/public_html
	else
		echo "Ups.. cant restore or add domain: $sk_da_dom"
	fi
done
echo " "
echo "Domains restored!"
tput setaf 2
echo "Start restoring mails"
tput sgr0
function sk_da_restore_imap_pass() {
	if [ -d /etc/exim ]; then
		EXIM=/etc/exim
	else
		EXIM=/etc/exim4
	fi
	sk_actual_pass=$(grep -w $1 ${EXIM}/domains/$2/passwd | tr '}' ' ' | tr ':' ' ' | cut -d " " -f 3)
	sk_da_orig_pass=$(grep -w $1 ${b}/$2/email/passwd | tr ':' ' ' | cut -d " " -f2)
	replace "${sk_actual_pass}" "${sk_da_orig_pass}" -- ${EXIM}/domains/$2/passwd
	echo "Password for $1@$2 restored"
	#################
	# fix vesta needed
}
if [ -e sk_restored_domains ]; then
	cat sk_restored_domains | while read sk_da_mail_domain; do
		if [ "$(ls -A ${b}/${sk_da_mail_domain}/email/data/imap/)" ]; then
			tput setaf 2
			echo "Found Imap for ${sk_da_mail_domain}"
			tput sgr0
			ls -1 ${b}/${sk_da_mail_domain}/email/data/imap/ | while read sk_da_imap; do
				$BIN/v-add-mail-account $directadmin_user $sk_da_mail_domain $sk_da_imap temp
				if [ "$debug" != 0 ]; then
					rsync -av ${b}/${sk_da_mail_domain}/email/data/imap/${sk_da_imap}/Maildir/ /home/${directadmin_user}/mail/${sk_da_mail_domain}/${sk_da_imap} 2>&1 |
						while read backup_file_dm; do
							sk_sync=$((sk_sync + 1))
							echo -en "-- $sk_sync restored files\r"
						done
					echo " "
				else
					rsync ${b}/${sk_da_mail_domain}/email/data/imap/${sk_da_imap}/Maildir/ /home/${directadmin_user}/mail/${sk_da_mail_domain}/${sk_da_imap}
				fi
				chown ${directadmin_user}:mail -R /home/${directadmin_user}/mail/${sk_da_mail_domain}/${sk_da_imap}
				sk_da_restore_imap_pass $sk_da_imap $sk_da_mail_domain
			done

		fi
	done
fi
delete_tmp
echo "Account $directadmin_user restored"
echo "Report eny errores in skamasle.com or in vesta forum ( official forum thread ) "
echo "Or in twitter @skamasle"
echo "This was powered by skamasle.com | Maks Usmanov"
